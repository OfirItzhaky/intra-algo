<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scalping Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    #paste-dropzone:focus, #paste-dropzone:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
        outline: none;
    }
    .floating-rag-panel {
        position: fixed;
        top: 80px;
        width: 380px;
        max-height: 70vh;
        background: #fff;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        border-radius: 10px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        border: 1px solid #e0e0e0;
    }
    .floating-rag-panel-left { left: 24px; }
    .floating-rag-panel-right { right: 24px; }
    .floating-rag-panel-header {
        padding: 12px 16px;
        font-weight: bold;
        background: #f5f5f7;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .floating-rag-panel-content {
        padding: 16px;
        overflow-y: auto;
        font-size: 1rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .floating-rag-panel-close {
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
    }
    @media (max-width: 900px) {
        .floating-rag-panel { width: 95vw; left: 2.5vw; right: 2.5vw; }
    }
    .fade-out {
        opacity: 0.4;
        transition: opacity 0.4s;
    }
    .fade-in {
        opacity: 1;
        transition: opacity 0.5s;
    }
    .shimmer {
        height: 18px;
        width: 100px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
        border-radius: 6px;
        margin-bottom: 8px;
    }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .rag-flash {
        box-shadow: 0 0 0 3px #ffe066, 0 2px 8px rgba(0,0,0,0.08);
        transition: box-shadow 0.5s;
    }
    </style>
</head>
<body style="font-family: Arial; margin: 40px;">
<div class="container">
    {% include "shared_ui_blocks.html" %}
    <div class="tab-content" id="scalpAgentTabContent">
      <!-- TAB 1: SETUP -->
      <div class="tab-pane fade show active" id="setup" role="tabpanel" aria-labelledby="setup-tab">
        <form id="setup-form" method="POST" enctype="multipart/form-data" class="mb-4">
          <div class="mb-3">
            <label for="max_risk" class="form-label">Max Daily Risk</label>
            <input type="number" step="any" class="form-control" id="max_risk" name="max_risk" placeholder="Enter your daily max risk" required>
            <div class="form-text">This is your total loss cap for the day. The agent will not suggest trades that may exceed this.</div>
          </div>
          <div class="mb-3">
            <label for="max_risk_per_trade" class="form-label">Max Risk Per Trade</label>
            <input type="number" step="any" class="form-control" id="max_risk_per_trade" name="max_risk_per_trade" placeholder="Enter max risk per trade (optional)">
          </div>
          <div class="mb-3">
            <label for="session_notes" class="form-label">Session Notes (optional)</label>
            <textarea class="form-control" id="session_notes" name="session_notes" rows="3" placeholder="Enter any notes..."></textarea>
          </div>
          <div class="mb-2 d-flex align-items-center">
            <hr class="flex-grow-1 me-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
            <span style="font-weight: bold; color: #222; font-size: 1.08rem; white-space:nowrap;">Multi-Timeframe Agent</span>
            <hr class="flex-grow-1 ms-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
          </div>
          <div id="paste-dropzone" class="border border-primary rounded p-4 mb-3 text-center" tabindex="0" style="background: #f8f9fa; cursor: pointer;">
            <span class="text-secondary">
              <strong>📋 Paste chart images here (Ctrl+V)</strong><br>
              <small>Or use the file upload below (multiple images supported)</small>
            </span>
            <div id="multi-image-preview" class="mt-3" style="display: flex; flex-wrap: wrap; gap: 12px; overflow-x: auto;"></div>
          </div>
          <input type="file" class="form-control" id="chart_file" name="chart_file" accept="image/*" multiple style="margin-top: 8px;">
          <button id="run-multitimeframe-agent-btn" class="btn fw-bold text-uppercase mb-3" type="button" style="background-color: #66bb6a; color: #fff; border-radius: 0.375rem; padding: 0.5rem 1.25rem; font-size: 1rem; width: 100%; max-width: none; min-width: 0;">
            Run MultiTimeframe Agent
          </button>
          <div class="mb-2 d-flex align-items-center">
            <hr class="flex-grow-1 me-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
            <span style="font-weight: bold; color: #222; font-size: 1.08rem; white-space:nowrap;">Regression Agent</span>
            <hr class="flex-grow-1 ms-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
          </div>
          <div class="mb-3 d-flex flex-row gap-2" style="width: 100%; align-items: end;">
            <div style="flex: 1;">
              <label for="csv_file" class="form-label">Upload CSV (OHLCV + indicators)</label>
              <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv,.txt,.xlsx,.xls" multiple>
            </div>
            <div style="flex: 1; display: flex; align-items: flex-end;">
              <button id="run-regression-strategy-btn" type="button" class="btn btn-success fw-bold text-uppercase" style="display:inline-block; width: 100%; min-width: 0; background-color: #198754; color: #fff; border-radius: 0.375rem; padding: 0.5rem 1.25rem; font-size: 1rem;" disabled>
                <span style="vertical-align: middle;">💡 Run Regression Predictor Strategy</span>
              </button>
            </div>
          </div>
          <div class="mb-2 d-flex align-items-center">
            <hr class="flex-grow-1 me-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
            <span style="font-weight: bold; color: #222; font-size: 1.08rem; white-space:nowrap;">VWAP Agent</span>
            <hr class="flex-grow-1 ms-2" style="height:2px; background:#222; opacity:0.2; border:none; margin:0;">
          </div>
          <div class="d-flex justify-content-end mb-3">
            <button id="run-vwap-strategy-btn" type="button" class="btn" style="display:inline-block; min-width:260px; background-color: #7c3aed; color: #fff; font-weight: 600; border-radius: 0.375rem; transition: background 0.2s;" title="Run VWAP Strategy Agent">🚀 Run VWAP Strategy Agent</button>
          </div>
          <div id="csv-summary-list" class="mb-2"></div>
          {% if csv_summaries and csv_summaries|length > 0 %}
            <div class="mb-2">
              <ul class="list-unstyled mb-0">
                {% for csv in csv_summaries %}
                  <li>
                    📄 <b>{{ csv.filename }}</b>:
                    {% if csv.error %}
                      <span class="text-danger">Error: {{ csv.error }}</span>
                    {% else %}
                      <span class="text-primary">{{ csv.num_bars }}</span> bars loaded (<span class="text-secondary">{{ csv.timeframe }}</span>)
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <div class="action-btns-container" style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
            <div class="d-flex flex-row gap-2" style="width: 100%;">
              <button id="run-instinct-btn" class="btn btn-primary fw-bold text-uppercase flex-fill" type="button" style="min-width: 0;">
                Run Instinct Agent
              </button>
              <button id="run-playbook-btn" class="btn btn-success fw-bold text-uppercase flex-fill" type="button" style="min-width: 0;">
                Run Playbook Agent
              </button>
            </div>
          </div>
          <div id="multitimeframe-agent-result" class="mt-3"></div>
          <!-- HIGHLIGHTED: Playbook response container for feedback/messages -->
          <div id="playbook-response-container" class="mt-2"></div>
          <div id="bias-summary-block"></div>
          <!-- END HIGHLIGHTED -->
        </form>
      </div>
      <!-- TAB 2: INTERACTION -->
      <div class="tab-pane fade" id="interaction" role="tabpanel" aria-labelledby="interaction-tab">
        <div class="row">
          <!-- Instinct Agent Panel -->
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <strong>Instinct Agent Results</strong>
                <button class="btn btn-outline-secondary btn-sm ms-2" type="button" onclick="toggleRagPanel('instinct')">🧠 Toggle RAG View</button>
              </div>
              <div class="card-body" id="instinct_output">
                <!-- InstinctAgent output will be rendered here -->
              </div>
              <div class="card-footer">
                <div class="input-group mb-2">
                  <input type="text" class="form-control" id="instinct_query_input" placeholder="Ask Instinct Agent a question...">
                  <button class="btn btn-outline-primary" type="button" id="send_instinct_query">Send</button>
                </div>
                <div class="mb-2">
                  <input type="file" class="form-control mt-2" id="enhance-instinct-csv" accept=".csv,.txt,.xlsx,.xls">
                  <textarea class="form-control mt-2" id="enhance-instinct-notes" rows="2" placeholder="Add clarification or extra notes (optional)"></textarea>
                  <button type="button" class="btn btn-outline-info mt-2" id="enhance-instinct-btn" disabled>🧪 Enhance Strategy</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Playbook Agent Panel -->
          <div class="col-md-6">
            <div class="card mb-4">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <strong>Playbook Strategy Results</strong>
                <button class="btn btn-outline-secondary btn-sm ms-2" type="button" onclick="toggleRagPanel('playbook')">🧠 Toggle RAG View</button>
              </div>
              <div class="card-body" id="playbook_output">
                <!-- PlaybookAgent output will be rendered here -->
              </div>
              <div class="card-footer">
                <div class="input-group mb-2">
                  <input type="text" class="form-control" id="playbook_query_input" placeholder="Ask Playbook Agent a question...">
                  <button class="btn btn-outline-success" type="button" id="send_playbook_query">Send</button>
                </div>
                <div class="mb-2">
                  <input type="file" class="form-control mt-2" id="enhance-playbook-csv" accept=".csv,.txt,.xlsx,.xls">
                  <textarea class="form-control mt-2" id="enhance-playbook-notes" rows="2" placeholder="Add clarification or extra notes (optional)"></textarea>
                  <button type="button" class="btn btn-outline-info mt-2" id="enhance-playbook-btn" disabled>🧪 Enhance Strategy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<!-- Add marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('paste-dropzone');
    const multiPreviewArea = document.getElementById('multi-image-preview');
    let chartFileInput = document.getElementById('chart_file');
    const runInstinctBtn = document.getElementById('run-instinct-btn');
    const runPlaybookBtn = document.getElementById('run-playbook-btn');
    const instinctOutput = document.getElementById('instinct_output');
    const playbookOutput = document.getElementById('playbook_output');
    const csvFileInput = document.getElementById('csv_file');
    const sessionNotesInput = document.getElementById('session_notes');
    const maxRiskInput = document.getElementById('max_risk');
    const maxRiskPerTradeInput = document.getElementById('max_risk_per_trade');

    // If not present, create a hidden input for chart_file
    if (!chartFileInput) {
        chartFileInput = document.createElement('input');
        chartFileInput.type = 'file';
        chartFileInput.id = 'chart_file';
        chartFileInput.name = 'chart_file';
        chartFileInput.style.display = 'none';
        document.querySelector('form').prepend(chartFileInput);
    }

    // --- MULTI-IMAGE STATE ---
    let chartImages = []; // { file: File, url: string, tag: string }
    const TIMEFRAME_OPTIONS = ["15m", "30m", "60m", "4h", "Daily", "Weekly"];

    function renderMultiImagePreview() {
        multiPreviewArea.innerHTML = '';
        chartImages.forEach((img, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'border rounded p-2 d-flex flex-column align-items-center';
            wrapper.style.width = '120px';
            wrapper.style.position = 'relative';
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-close position-absolute top-0 end-0 m-1';
            removeBtn.style.zIndex = 2;
            removeBtn.title = 'Remove image';
            removeBtn.onclick = () => {
                chartImages.splice(idx, 1);
                renderMultiImagePreview();
            };
            wrapper.appendChild(removeBtn);
            // Image
            const imgElem = document.createElement('img');
            imgElem.src = img.url;
            imgElem.style.maxWidth = '90px';
            imgElem.style.maxHeight = '70px';
            imgElem.className = 'mb-1';
            wrapper.appendChild(imgElem);
            // Timeframe tag dropdown
            const tfSelect = document.createElement('select');
            tfSelect.className = 'form-select form-select-sm mt-1';
            tfSelect.style.width = '90px';
            TIMEFRAME_OPTIONS.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                if (img.tag === opt) option.selected = true;
                tfSelect.appendChild(option);
            });
            tfSelect.value = img.tag || '';
            tfSelect.onchange = (e) => {
                img.tag = e.target.value;
            };
            wrapper.appendChild(tfSelect);
            // Label
            const label = document.createElement('div');
            label.className = 'text-muted small mt-1';
            label.textContent = img.file.name || 'Pasted Image';
            wrapper.appendChild(label);
            multiPreviewArea.appendChild(wrapper);
        });
    }

    // Handle file input (multiple)
    chartFileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                chartImages.push({ file, url: event.target.result, tag: '' });
                renderMultiImagePreview();
            };
            reader.readAsDataURL(file);
        });
        // Reset input so same file can be re-added if removed
        chartFileInput.value = '';
    });

    // Handle paste (multiple images)
    dropzone.addEventListener('paste', function(e) {
        let items = (e.clipboardData || window.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
            let item = items[i];
            if (item.type.indexOf('image') !== -1) {
                let blob = item.getAsFile();
                let file = new File([blob], `pasted_chart_${Date.now()}_${i}.png`, {type: blob.type});
                let reader = new FileReader();
                reader.onload = function(event) {
                    chartImages.push({ file, url: event.target.result, tag: '' });
                    renderMultiImagePreview();
                };
                reader.readAsDataURL(file);
            }
        }
    });

    // Focus dropzone on click for better UX
    dropzone.addEventListener('click', function() {
        dropzone.focus();
    });

    // --- CSV INTERVAL DETECTION ---
    function inferIntervalFromContent(text) {
        // Try to parse the time column and compute the most common difference in minutes
        const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lines.length < 3) return null;
        const header = lines[0].split(/,|\t|;/).map(s => s.trim().toLowerCase());
        let timeIdx = header.findIndex(h => h === 'time' || h === 'datetime' || h === 'timestamp');
        if (timeIdx === -1) return null;
        let times = [];
        for (let i = 1; i < Math.min(lines.length, 50); ++i) {
            const cols = lines[i].split(/,|\t|;/);
            let t = cols[timeIdx];
            if (!t) continue;
            // Try to parse as HH:MM or HH:MM:SS
            let m = t.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
            if (m) {
                let h = parseInt(m[1], 10), m2 = parseInt(m[2], 10), s = m[3] ? parseInt(m[3], 10) : 0;
                times.push(h * 60 + m2 + s / 60);
            }
        }
        if (times.length < 2) return null;
        let diffs = times.slice(1).map((t, i) => t - times[i]);
        let minDiff = diffs.reduce((a, b) => Math.abs(a) < Math.abs(b) ? a : b);
        if (Math.abs(minDiff - 1) < 0.1) return '1m';
        if (Math.abs(minDiff - 5) < 0.1) return '5m';
        if (Math.abs(minDiff - 15) < 0.1) return '15m';
        if (Math.abs(minDiff - 30) < 0.1) return '30m';
        if (Math.abs(minDiff - 60) < 1) return '60m';
        return `${minDiff}m`;
    }

    // --- CSV SUMMARY LIST (show detected interval) ---
    function updateCsvSummaryList() {
        const csvSummaryDiv = document.getElementById('csv-summary-list');
        const files = csvFileInput.files;
        if (!files || files.length === 0) {
            csvSummaryDiv.innerHTML = '';
            return;
        }
        let html = '<ul class="list-unstyled mb-0">';
        let filesProcessed = 0;
        Array.from(files).forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                const numBars = Math.max(0, lines.length - 1); // header
                const tf = inferIntervalFromContent(text) || 'Unknown';
                html += `<li>📄 <b>${file.name}</b>: <span class='text-primary'>${numBars}</span> bars loaded (<span class='text-secondary'>${tf}</span>)</li>`;
                filesProcessed++;
                if (filesProcessed === files.length) {
                    html += '</ul>';
                    csvSummaryDiv.innerHTML = html;
                }
            };
            reader.readAsText(file);
        });
    }
    csvFileInput.addEventListener('change', updateCsvSummaryList);

    // --- FORM DATA: append all images and tags ---
    function getFormData() {
        const formData = new FormData();
        // Chart images
        chartImages.forEach((img, idx) => {
            formData.append('chart_files', img.file); // Flask: request.files.getlist('chart_files')
            formData.append(`chart_file_tag_${idx}`, img.tag || '');
        });
        // CSVs
        if (csvFileInput.files.length > 0) {
            Array.from(csvFileInput.files).forEach(file => {
                formData.append('csv_files', file); // Flask: request.files.getlist('csv_files')
            });
        }
        formData.append('session_notes', sessionNotesInput.value);
        formData.append('max_risk', maxRiskInput.value);
        formData.append('max_risk_per_trade', maxRiskPerTradeInput.value);
        return formData;
    }

    // LLM cost tracker state
    let totalTokens = 0;
    let totalCost = 0;
    const TOKEN_RATE = 0.0015 / 1000; // $0.0015 per 1K tokens
    const llmTokensElem = document.getElementById('llm-tokens');
    const llmCostElem = document.getElementById('llm-cost');

    function addTokens(tokens) {
        if (!tokens || isNaN(tokens)) return;
        totalTokens += tokens;
        totalCost = totalTokens * TOKEN_RATE;
        llmTokensElem.textContent = totalTokens.toLocaleString();
        llmCostElem.textContent = '$' + totalCost.toFixed(4);
    }

    // Helper: Render InstinctAgent output in a structured way
    function renderInstinctAgentResult(data) {
        if (!data || typeof data !== 'object') {
            return '<div class="alert alert-warning">No result.</div>';
        }
        let html = '';
        // Feedback (if present)
        if (data.feedback) {
            html += `<div class="alert alert-warning mb-3"><strong>Feedback:</strong> <br>${data.feedback}</div>`;
        }
        // Summary
        if (data.summary) {
            html += `<div class="mb-3"><strong>💬 Summary:</strong><br><p>${data.summary}</p></div>`;
        }
        // Strategies (single or list)
        let strategies = data.strategies;
        if (strategies && !Array.isArray(strategies)) strategies = [strategies];
        if (strategies && Array.isArray(strategies) && strategies.length > 0) {
            html += `<div class="mb-3"><strong>⚙️ Strategy:</strong>`;
            strategies.forEach((strat, idx) => {
                if (!strat) return;
                html += `<div class="card mb-2"><div class="card-body p-2">`;
                html += `<table class="table table-sm mb-1"><tbody>`;
                if (strat.entry_rule) html += `<tr><th>Entry Rule</th><td>${strat.entry_rule}</td></tr>`;
                if (strat.confirmation) html += `<tr><th>Confirmation</th><td>${strat.confirmation}</td></tr>`;
                if (strat.stop_rule) html += `<tr><th>Stop Rule</th><td>${strat.stop_rule}</td></tr>`;
                if (strat.target_rule) html += `<tr><th>Target Rule</th><td>${strat.target_rule}</td></tr>`;
                if (strat.tags) html += `<tr><th>Tags</th><td>${Array.isArray(strat.tags) ? strat.tags.join(', ') : strat.tags}</td></tr>`;
                if (strat.complexity) html += `<tr><th>Complexity</th><td>${strat.complexity}</td></tr>`;
                html += `</tbody></table>`;
                html += `</div></div>`;
            });
            html += `</div>`;
        }
        // Support/Resistance Zones (if present)
        if (data["support_resistance_zones"] && Array.isArray(data["support_resistance_zones"]) && data["support_resistance_zones"].length > 0) {
            html += `<div class="mb-3"><strong>🧱 Support/Resistance Zones:</strong><ul>`;
            data["support_resistance_zones"].forEach(zone => {
                html += `<li>${zone}</li>`;
            });
            html += `</ul></div>`;
        }
        return html;
    }

    // Helper: Render PlaybookAgent output in a structured way (similar to InstinctAgent)
    function renderPlaybookAgentResult(data) {
        if (!data || typeof data !== 'object') {
            return '<div class="alert alert-warning">No result.</div>';
        }
        let html = '';
        // HIGHLIGHTED: Show input validation error if present
        if (data.feedback && data.step === 'validation_failed') {
            html += `<div class="alert alert-danger mb-3"><strong>⚠️ Input Validation Error</strong><br>${data.feedback}</div>`;
            return html; // Only show this error, skip rest
        }
        // END HIGHLIGHTED
        // --- Bias Summary block (multi-image) ---
        if (Array.isArray(data.bias_summary) && data.bias_summary.length > 0) {
            html += `<div class="card border-warning mb-3" style="max-width: 28rem;">
                <div class="card-header bg-warning text-dark"><strong>Bias Summary</strong></div>
                <div class="card-body pb-2 pt-2">
                  <ul class="list-unstyled mb-0">`;
            data.bias_summary.forEach(bias => {
                let icon = '';
                const tf = (bias.interval || '').toLowerCase();
                if (tf.includes('day')) icon = '🗓';
                else if (tf.includes('60') || tf.includes('1h')) icon = '🕐';
                else if (tf.includes('15')) icon = '🕒';
                else if (tf.includes('30')) icon = '🕧';
                else icon = '⏱';
                const conf = bias.confidence !== undefined ? ` (Confidence: ${(bias.confidence * 100).toFixed(0)}%)` : '';
                html += `<li class="mb-1">${icon} <strong>${bias.interval || ''}</strong> → <span class="fw-bold">${bias.bias_direction}</span>${conf}</li>`;
            });
            html += `</ul></div></div>`;
        }
        // --- End Bias Summary block ---
        // HIGHLIGHTED: Show Multi-Timeframe Bias Summary if present
        if (data.multi_tf_bias && typeof data.multi_tf_bias === 'object' && Object.keys(data.multi_tf_bias).length > 0) {
            html += `<div class="card border-info mb-3" style="max-width: 28rem;">`;
            html += `<div class="card-header bg-info text-white"><strong>Multi-Timeframe Bias</strong></div>`;
            html += `<div class="card-body">`;
            html += `<ul class="list-unstyled mb-0">`;
            for (const [tf, bias] of Object.entries(data.multi_tf_bias)) {
                let icon = '';
                if (tf.toLowerCase().includes('day')) icon = '🗓';
                else if (tf.includes('60') || tf.includes('1h')) icon = '🕐';
                else if (tf.includes('15')) icon = '🕒';
                else if (tf.includes('30')) icon = '🕧';
                else icon = '⏱';
                html += `<li class="mb-1">${icon} <strong>${tf}:</strong> ${bias}</li>`;
            }
            html += `</ul></div></div>`;
        }
        // END HIGHLIGHTED
        // Show feedback if present (other cases)
        if (data.feedback) {
            html += `<div class="alert alert-warning mb-3"><strong>⚠️ ${data.feedback}</strong></div>`;
        }
        // Summary
        if (data.summary) {
            html += `<div class="mb-3"><strong>💬 Summary:</strong><br><p>${data.summary}</p></div>`;
        }
        // Strategies (single or list)
        let strategies = data.strategies;
        if (strategies && !Array.isArray(strategies)) strategies = [strategies];
        if (strategies && Array.isArray(strategies) && strategies.length > 0) {
            html += `<div class="mb-3"><strong>⚙️ Strategy:</strong>`;
            strategies.forEach((strat, idx) => {
                if (!strat) return;
                html += `<div class="card mb-2"><div class="card-body p-2">`;
                html += `<table class="table table-sm mb-1"><tbody>`;
                if (strat.entry_rule) html += `<tr><th>Entry Rule</th><td>${strat.entry_rule}</td></tr>`;
                if (strat.confirmation) html += `<tr><th>Confirmation</th><td>${strat.confirmation}</td></tr>`;
                if (strat.stop_rule) html += `<tr><th>Stop Rule</th><td>${strat.stop_rule}</td></tr>`;
                if (strat.target_rule) html += `<tr><th>Target Rule</th><td>${strat.target_rule}</td></tr>`;
                if (strat.tags) html += `<tr><th>Tags</th><td>${Array.isArray(strat.tags) ? strat.tags.join(', ') : strat.tags}</td></tr>`;
                if (strat.complexity) html += `<tr><th>Complexity</th><td>${strat.complexity}</td></tr>`;
                html += `</tbody></table>`;
                html += `</div></div>`;
            });
            html += `</div>`;
        }
        // Support/Resistance Zones (if present)
        if (data["support_resistance_zones"] && Array.isArray(data["support_resistance_zones"]) && data["support_resistance_zones"].length > 0) {
            html += `<div class="mb-3"><strong>🧱 Support/Resistance Zones:</strong><ul>`;
            data["support_resistance_zones"].forEach(zone => {
                html += `<li>${zone}</li>`;
            });
            html += `</ul></div>`;
        }
        return html;
    }

    // Try to extract token usage from response (if present)
    function extractTokenCount(data) {
        if (data) {
            if (data.totalTokenCount) {
                return parseInt(data.totalTokenCount);
            }
            if (data.tokens_used) {
                return parseInt(data.tokens_used);
            }
        }
        return 800;
    }

    function toggleRagPanel(agent) {
        const panel = document.getElementById(`rag-${agent}-panel`);
        if (panel) {
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
        }
    }

    function renderRagMarkdown(content) {
        if (window.marked) {
            return marked.parse(content || '');
        }
        // Fallback: replace newlines with <br>
        return (content || '').replace(/\n/g, '<br>');
    }

    let lastInstinctContext = null;
    let lastPlaybookContext = null;

    function enableEnhanceButton(agent) {
        document.getElementById(`enhance-${agent}-btn`).disabled = false;
        document.getElementById(`enhance-${agent}-inputs`).style.display = 'block';
    }

    function showLoadingState(agent) {
        const output = document.getElementById(`${agent}_output`);
        output.classList.add('fade-out');
        // Insert spinner/shimmer at top if not present
        let spinnerId = `${agent}-spinner`;
        if (!document.getElementById(spinnerId)) {
            const spinner = document.createElement('div');
            spinner.id = spinnerId;
            spinner.innerHTML = `<div class="d-flex align-items-center mb-2"><div class="spinner-border text-${agent === 'instinct' ? 'info' : 'success'} me-2" role="status" style="width: 1.5rem; height: 1.5rem;"></div><span>Running...</span></div>`;
            output.parentNode.insertBefore(spinner, output);
        }
    }
    function hideLoadingState(agent) {
        const output = document.getElementById(`${agent}_output`);
        output.classList.remove('fade-out');
        output.classList.add('fade-in');
        setTimeout(() => output.classList.remove('fade-in'), 600);
        let spinner = document.getElementById(`${agent}-spinner`);
        if (spinner) spinner.remove();
    }
    function setButtonLoading(btn, isLoading) {
        if (isLoading) {
            btn.disabled = true;
            btn.dataset.originalText = btn.textContent;
            btn.textContent = 'Running...';
        } else {
            btn.disabled = false;
            if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
        }
    }
    function flashRagPanel(agent) {
        const panel = document.getElementById(`rag-${agent}-panel`);
        if (panel) {
            panel.classList.add('rag-flash');
            setTimeout(() => panel.classList.remove('rag-flash'), 700);
        }
    }

    runInstinctBtn.addEventListener('click', function() {
        showLoadingState('instinct');
        setButtonLoading(runInstinctBtn, true);
        instinctOutput.innerHTML = '';
        fetch('/start_instinct', {
            method: 'POST',
            body: getFormData()
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingState('instinct');
            setButtonLoading(runInstinctBtn, false);
            instinctOutput.innerHTML = renderInstinctAgentResult(data);
            addTokens(extractTokenCount(data));
            if (data && data.rag_insights) {
                document.getElementById('rag-instinct-content').innerHTML = renderRagMarkdown(data.rag_insights);
                document.getElementById('rag-instinct-panel').style.display = 'block';
                flashRagPanel('instinct');
            }
            lastInstinctContext = {
                ...getFormData(),
                result: data
            };
            enableEnhanceButton('instinct');
        })
        .catch(err => {
            hideLoadingState('instinct');
            setButtonLoading(runInstinctBtn, false);
            instinctOutput.innerHTML = '<div class="alert alert-danger">Error: ' + err + '</div>';
        });
    });

    runPlaybookBtn.addEventListener('click', function() {
        showLoadingState('playbook');
        setButtonLoading(runPlaybookBtn, true);
        playbookOutput.innerHTML = '';
        // HIGHLIGHTED: Clear response container before new run
        document.getElementById('playbook-response-container').innerHTML = '';
        // Clear bias summary before new run
        const biasSummaryDiv = document.getElementById('bias-summary-block');
        if (biasSummaryDiv) biasSummaryDiv.innerHTML = '';
        fetch('/start_playbook', {
            method: 'POST',
            body: getFormData()
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingState('playbook');
            setButtonLoading(runPlaybookBtn, false);
            // HIGHLIGHTED: Show feedback in response container if present
            const responseContainer = document.getElementById('playbook-response-container');
            if (data.feedback) {
                responseContainer.innerHTML = `<div class="alert alert-warning"><strong>⚠️ ${data.feedback}</strong></div>`;
            } else {
                responseContainer.innerHTML = '';
            }
            // END HIGHLIGHTED
            // --- Render Bias Summary block below response container ---
            const biasDiv = document.getElementById('bias-summary-block');
            if (biasDiv) {
                if (Array.isArray(data.bias_summary) && data.bias_summary.length > 0) {
                    let html = '<h4 class="mt-2 mb-2">🧠 Multi-Timeframe Bias Summary</h4><ul class="mb-2">';
                    data.bias_summary.forEach(bias => {
                        const conf = bias.confidence !== undefined ? ` (${(bias.confidence * 100).toFixed(0)}%)` : '';
                        html += `<li><b>${bias.interval || ''}</b> → ${bias.bias_direction}${conf} – ${bias.reasoning || ''}</li>`;
                    });
                    html += '</ul>';
                    // --- Regression Predictor Button & CSV Info ---
                    html += `<div id="regression-csv-info" class="mb-2 text-end"></div>`;
                    html += `<div id="regression-strategy-result"></div>`;
                } else {
                    let html = '<div class="alert alert-info">No bias summary returned. Showing raw Gemini insights instead:</div>';
                    if (Array.isArray(data.raw_bias_data) && data.raw_bias_data.length > 0) {
                        data.raw_bias_data.forEach(item => {
                            html += `<pre>${item.reasoning_summary || ''}</pre>`;
                        });
                    }
                    biasDiv.innerHTML = html;
                }
            }
            // --- End Bias Summary block ---
            playbookOutput.innerHTML = renderPlaybookAgentResult(data);
            addTokens(extractTokenCount(data));
            if (data && data.rag_insights) {
                document.getElementById('rag-playbook-content').innerHTML = renderRagMarkdown(data.rag_insights);
                document.getElementById('rag-playbook-panel').style.display = 'block';
                flashRagPanel('playbook');
            }
            lastPlaybookContext = {
                ...getFormData(),
                result: data
            };
            enableEnhanceButton('playbook');

            // --- Regression Predictor Button Logic ---
            setTimeout(() => {
                const regBtn = document.getElementById('run-regression-strategy-btn');
                const regResultDiv = document.getElementById('regression-strategy-result');
                const regCsvInfo = document.getElementById('regression-csv-info');
                if (regBtn) {
                    // Check CSV info
                    let csvRows = 0;
                    let csvInterval = '';
                    if (csvFileInput.files.length > 0) {
                        const file = csvFileInput.files[0];
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const text = e.target.result;
                            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                            csvRows = lines.length - 1; // header
                            // Try to infer interval from filename or header
                            csvInterval = file.name.match(/(\d+m|\d+h|daily|minute|hour)/i)?.[0] || '';
                            regCsvInfo.innerHTML = `<span class='text-secondary'>📄 CSV Detected: <b>${csvRows}</b> bars loaded${csvInterval ? ` (${csvInterval})` : ''}</span>`;
                            if (csvRows < 500) {
                                regCsvInfo.innerHTML += ` <span class='text-warning ms-2'>⚠️ Not enough bars (min: 500 required)</span>`;
                                regBtn.disabled = true;
                            } else {
                                regBtn.disabled = false;
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        regCsvInfo.innerHTML = `<span class='text-danger'>No CSV uploaded. Please upload a CSV to run regression strategy.</span>`;
                        regBtn.disabled = true;
                    }
                    regBtn.onclick = function() {
                        if (regBtn.disabled) return;
                        regBtn.disabled = true;
                        regBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running...';
                        regResultDiv.innerHTML = '';
                        const csvFileInput = document.getElementById('csv_file');
                        const files = csvFileInput && csvFileInput.files ? csvFileInput.files : [];
                        const formData = new FormData();
                        Array.from(files).forEach(file => formData.append('csv_files', file));
                        console.log('Calling /run_regression_predictor with files:', Array.from(files).map(f => f.name));
                        // polling = true;
                        // pollProgress(); // --- DISABLED: synchronous, no progress bar ---
                        fetch('/run_regression_predictor', {
                          method: 'POST',
                          body: formData
                        })
                        .then(resp => resp.json())
                        .then(result => {
                          regBtn.disabled = false;
                          regBtn.innerHTML = '💡 Run Regression Predictor Strategy';
                          let out = '';
                          if (result.feedback) {
                            out += `<div class='alert alert-warning'>${result.feedback}</div>`;
                          }
                          if (result.strategy_name) {
                            out += `<div class='card border-success mb-2'><div class='card-header bg-success text-white'><b>${result.strategy_name}</b></div><div class='card-body'>`;
                            out += `<div class='mb-2'><b>Entry Conditions:</b> min_high_delta=${result.entry_conditions?.min_high_delta}, min_low_delta=${result.entry_conditions?.min_low_delta}</div>`;
                            out += `<ul class='mb-2'>`;
                            const s = result.backtest_summary || {};
                            out += `<li><b>Num trades:</b> ${s.num_trades ?? '-'}</li>`;
                            out += `<li><b>Win rate:</b> ${(s.win_rate*100).toFixed(1) ?? '-'}%</li>`;
                            out += `<li><b>Avg return:</b> ${s.avg_return?.toFixed(2) ?? '-'}</li>`;
                            out += `<li><b>Avg duration:</b> ${s.avg_duration?.toFixed(1) ?? '-'}</li>`;
                            out += `<li><b>Max drawdown:</b> ${s.max_drawdown?.toFixed(2) ?? '-'}</li>`;
                            out += `<li><b>Profit factor:</b> ${s.profit_factor?.toFixed(2) ?? '-'}</li>`;
                            out += `</ul>`;
                            if (result.llm_summary) {
                              out += `<div class='mb-2'><b>Summary:</b> ${result.llm_summary}</div>`;
                            }
                            if (result.model_scores) {
                              out += `<div class='mb-2'><b>Model R²:</b> high=${result.model_scores.high_r2?.toFixed(3)}, low=${result.model_scores.low_r2?.toFixed(3)}</div>`;
                            }
                            if (result.cost_metadata) {
                              out += `<div class='small text-muted'>Tokens: ${result.cost_metadata.prompt_tokens || '-'} + ${result.cost_metadata.output_tokens || '-'}, Cost: $${result.cost_metadata.total_cost_usd?.toFixed(4) || '0.0000'}</div>`;
                            }
                            if (Array.isArray(result.top_strategies) && result.top_strategies.length > 0) {
                              out += `<div class='card border-info mb-2'><div class='card-header bg-info text-white'><b>Top 3 Strategy Configurations</b></div><div class='card-body p-2'>`;
                              out += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                              out += `<th>Long Threshold</th><th>Short Threshold</th><th>Win Rate</th><th>Avg Return</th><th>Profit Factor</th><th>Drawdown</th><th>Trades</th>`;
                              out += `</tr></thead><tbody>`;
                              result.top_strategies.forEach((cfg) => {
                                out += `<tr>`;
                                out += `<td>${cfg.long_threshold}</td>`;
                                out += `<td>${cfg.short_threshold}</td>`;
                                out += `<td>${(cfg.win_rate*100).toFixed(1)}%</td>`;
                                out += `<td>${cfg.avg_return?.toFixed(2) ?? '-'}</td>`;
                                out += `<td>${cfg.profit_factor?.toFixed(2) ?? '-'}</td>`;
                                out += `<td>${cfg.max_drawdown?.toFixed(2) ?? '-'}</td>`;
                                out += `<td>${cfg.num_trades ?? '-'}</td>`;
                                out += `</tr>`;
                              });
                              out += `</tbody></table></div>`;
                              out += `</div></div>`;
                            }
                            if (result.recommended_strategy_summary) {
                              out += `<div class='alert alert-success mt-2 mb-2'><b>Recommended Strategy:</b> ${result.recommended_strategy_summary}</div>`;
                            }
                            out += `</div></div>`;
                          }
                          regResultDiv.innerHTML = out;
                          // Show heatmap inline after regression results
                          const heatmapHtml = `<div class="mt-3"><h5>Heatmap</h5><img src="/heatmap?t=${Date.now()}" alt="Heatmap" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" /></div>`;
                          regResultDiv.innerHTML += heatmapHtml;
                          if (result.regression_trades_plot_path) {
                            // Automatically open the plot in a new tab
                            window.open(result.regression_trades_plot_path, '_blank');
                            // Optionally, you can still show a message below the heatmap
                            regResultDiv.innerHTML += `<div class="mt-3"><h5>Trades & Predictions Visualization opened in a new tab.</h5></div>`;
                          }
                          // After rendering the heatmap and metrics, add:
                          if (result.llm_top_strategies) {
                            console.log('[LLM DEBUG] llm_top_strategies:', result.llm_top_strategies, 'type:', typeof result.llm_top_strategies);
                            let llmObj = result.llm_top_strategies;
                            // If it's an array, render as table
                            if (Array.isArray(llmObj)) {
                                let llmInsightsDiv = document.getElementById('llm-strategy-insights-block');
                                if (!llmInsightsDiv) {
                                    llmInsightsDiv = document.createElement('div');
                                    llmInsightsDiv.id = 'llm-strategy-insights-block';
                                    regResultDiv.appendChild(llmInsightsDiv);
                                }
                                let html = `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
                                html += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                                html += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
                                html += `</tr></thead><tbody>`;
                                llmObj.forEach((s) => {
                                    html += `<tr>`;
                                    html += `<td>${s.name ?? '-'}</td>`;
                                    html += `<td>${s.logic ?? '-'}</td>`;
                                    html += `<td>${s.direction ?? '-'}</td>`;
                                    html += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                                    html += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                                    html += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                                    html += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                                    html += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                                    html += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                                    html += `<td>${s.rationale ?? '-'}</td>`;
                                    html += `</tr>`;
                                });
                                html += `</tbody></table></div>`;
                                llmInsightsDiv.innerHTML = html;
                                // Add cost and model info below the table
                                let costFields = [];
                                const costVal = (result.llm_top_strategies?.llm_cost_usd !== undefined)
                                    ? `$${parseFloat(result.llm_top_strategies.llm_cost_usd).toFixed(4)}`
                                    : (result.llm_cost_usd !== undefined ? `$${parseFloat(result.llm_cost_usd).toFixed(4)}` : '-');
                                costFields.push(`LLM Cost: ${costVal}`);
                                const modelVal = result.llm_top_strategies?.model_name || result.llm_model_name || result.model_name || '-';
                                costFields.push(`Model: ${modelVal}`);
                                if (costFields.length > 0) {
                                    llmInsightsDiv.innerHTML += `<div class='small text-muted mt-2'>${costFields.join(' | ')}</div>`;
                                }
                                return;
                            }
                            // ...existing object-based rendering...
                            if (llmObj && typeof llmObj === 'object' && Array.isArray(llmObj.top_strategies)) {
                              console.log('[LLM DEBUG] Rendering LLM table, top_strategies length:', llmObj.top_strategies.length);
                              pretty = `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
                              pretty += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                              pretty += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
                              pretty += `</tr></thead><tbody>`;
                              llmObj.top_strategies.forEach((s) => {
                                pretty += `<tr>`;
                                pretty += `<td>${s.name ?? '-'}</td>`;
                                pretty += `<td>${s.logic ?? '-'}</td>`;
                                pretty += `<td>${s.direction ?? '-'}</td>`;
                                pretty += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                                pretty += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                                pretty += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                                pretty += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                                pretty += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                                pretty += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                                pretty += `<td>${s.rationale ?? '-'}</td>`;
                                pretty += `</tr>`;
                              });
                              pretty += `</tbody></table></div>`;
                              if (llmObj.explanation || llmObj.rationale) {
                                pretty += `<div class='alert alert-info mt-2'><b>LLM Explanation:</b> ${llmObj.explanation ?? llmObj.rationale}</div>`;
                              }
                            } else {
                              console.log('[LLM DEBUG] Fallback rendering for llm_top_strategies:', llmObj);
                              // fallback: pretty print
                              if (typeof result.llm_top_strategies === 'object') {
                                pretty = `<pre>${JSON.stringify(result.llm_top_strategies, null, 2)}</pre>`;
                              } else {
                                pretty = `<pre>${result.llm_top_strategies}</pre>`;
                              }
                            }
                            llmInsightsDiv = document.getElementById('llm-strategy-insights-block');
                            if (!llmInsightsDiv) {
                                llmInsightsDiv = document.createElement('div');
                                llmInsightsDiv.id = 'llm-strategy-insights-block';
                                regResultDiv.appendChild(llmInsightsDiv);
                            }
                            let llmInsightsHtml = `<div class='card mt-3'>
                                <div class='card-header bg-primary text-white' style='cursor:pointer;' onclick='this.nextElementSibling.style.display = (this.nextElementSibling.style.display === "none" ? "block" : "none")'>
                                    <b>📊 LLM Strategy Insights (Click to Expand/Collapse)</b>
                                </div>
                                <div class='card-body' style='display:block;'>`;
                            // llm_summary
                            if (result.llm_summary) {
                                llmInsightsHtml += `<div class='mb-2'><b>LLM Summary:</b><br>${result.llm_summary}</div>`;
                            }
                            // recommended_strategy_summary
                            if (result.recommended_strategy_summary) {
                                llmInsightsHtml += `<div class='mb-2'><b>Recommended Strategy:</b><br>${result.recommended_strategy_summary}</div>`;
                            }
                            // llm_top_strategies
                            if (result.llm_top_strategies) {
                                let llmObj = result.llm_top_strategies;
                                // If it's a string, try to parse as JSON (strip markdown fences)
                                if (typeof llmObj === 'string') {
                                    // Remove ```json ... ``` or ``` ... ```
                                    let cleaned = llmObj.trim()
                                        .replace(/^```json\s*/i, '')
                                        .replace(/^```/, '')
                                        .replace(/```$/, '')
                                        .trim();
                                    try {
                                        llmObj = JSON.parse(cleaned);
                                    } catch (e) {
                                        llmInsightsHtml += `<div class='alert alert-warning'>Could not parse llm_top_strategies JSON: ${e}</div>`;
                                        llmObj = null;
                                    }
                                }
                                if (llmObj && typeof llmObj === 'object' && Array.isArray(llmObj.top_strategies)) {
                                    llmInsightsHtml += `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
                                    llmInsightsHtml += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                                    llmInsightsHtml += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
                                    llmInsightsHtml += `</tr></thead><tbody>`;
                                    llmObj.top_strategies.forEach((s) => {
                                        llmInsightsHtml += `<tr>`;
                                        llmInsightsHtml += `<td>${s.name ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.logic ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.direction ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                                        llmInsightsHtml += `<td>${s.rationale ?? '-'}</td>`;
                                        llmInsightsHtml += `</tr>`;
                                    });
                                    llmInsightsHtml += `</tbody></table></div>`;
                                    if (llmObj.explanation || llmObj.rationale) {
                                        llmInsightsHtml += `<div class='alert alert-info mt-2'><b>LLM Explanation:</b> ${llmObj.explanation ?? llmObj.rationale}</div>`;
                                    }
                                } else if (llmObj) {
                                    llmInsightsHtml += `<pre>${JSON.stringify(llmObj, null, 2)}</pre>`;
                                }
                            }
                            // Cost fields
                            let costFields = [];
                            const costVal = (result.llm_top_strategies?.llm_cost_usd !== undefined)
                                ? `$${parseFloat(result.llm_top_strategies.llm_cost_usd).toFixed(4)}`
                                : (result.llm_cost_usd !== undefined ? `$${parseFloat(result.llm_cost_usd).toFixed(4)}` : '-');
                            costFields.push(`LLM Cost: ${costVal}`);
                            // Try to get model name from llm_top_strategies first, then top-level
                            const modelVal = result.llm_top_strategies?.model_name || result.llm_model_name || result.model_name || '-';
                            costFields.push(`Model: ${modelVal}`);
                            if (costFields.length > 0) {
                                llmInsightsHtml += `<div class='small text-muted mt-2'>${costFields.join(' | ')}</div>`;
                            }
                            llmInsightsHtml += `</div></div>`;
                            llmInsightsDiv.innerHTML = llmInsightsHtml;
                          }
                        })
                        .catch(err => {
                          regBtn.disabled = false;
                          regBtn.innerHTML = '💡 Run Regression Predictor Strategy';
                          regResultDiv.innerHTML = `<div class='alert alert-danger'>Error: ${err}</div>`;
                        });
                    };
                }
            }, 0);
        })
        .catch(err => {
            hideLoadingState('playbook');
            setButtonLoading(runPlaybookBtn, false);
            playbookOutput.innerHTML = '<div class="alert alert-danger">Error: ' + err + '</div>';
        });
    });

    // --- MultiTimeframe Agent button logic ---
    const runMultiBtn = document.getElementById('run-multitimeframe-agent-btn');
    const multiResultDiv = document.getElementById('multitimeframe-agent-result');
    const regressionSectionDiv = document.createElement('div');
    regressionSectionDiv.id = 'regression-predictor-section';
    regressionSectionDiv.innerHTML = `
      <div id="regression-csv-info" class="mb-2 text-end"></div>
      <div id="regression-strategy-result"></div>
    `;
    if (!document.getElementById('regression-predictor-section')) {
      multiResultDiv.parentNode.insertBefore(regressionSectionDiv, multiResultDiv.nextSibling);
    }

    function updateRegressionButtonState() {
      const regBtn = document.getElementById('run-regression-strategy-btn');
      const regCsvInfo = document.getElementById('regression-csv-info');
      const csvFileInput = document.getElementById('csv_file');
      let csvRows = 0;
      let csvInterval = '';
      let csvIsValid = false;
      if (csvFileInput && csvFileInput.files.length > 0) {
        const file = csvFileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
          csvRows = lines.length - 1; // header
          csvInterval = file.name.match(/(\d+m|\d+h|daily|minute|hour)/i)?.[0] || '';
          regCsvInfo.innerHTML = `<span class='text-secondary'>📄 CSV Detected: <b>${csvRows}</b> bars loaded${csvInterval ? ` (${csvInterval})` : ''}</span>`;
          if (csvRows < 500) {
            regCsvInfo.innerHTML += ` <span class='text-warning ms-2'>⚠️ Not enough bars (min: 500 required)</span>`;
            csvIsValid = false;
          } else {
            csvIsValid = true;
          }
          regBtn.disabled = !csvIsValid;
        };
        reader.readAsText(file);
      } else {
        regCsvInfo.innerHTML = `<span class='text-danger'>No CSV uploaded. Please upload a CSV to run regression strategy.</span>`;
        regBtn.disabled = true;
      }
    }

    // Listen for CSV file changes
    if (csvFileInput) {
      csvFileInput.addEventListener('change', updateRegressionButtonState);
    }

    if (runMultiBtn) {
      runMultiBtn.addEventListener('click', function() {
        // Show spinner and running text inside the button
        runMultiBtn.disabled = true;
        let multiBtnOriginal = runMultiBtn.innerHTML;
        runMultiBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running...';
        multiResultDiv.innerHTML = '';
        const formData = getFormData(); // Reuse the same form data as Playbook
        fetch('/start_multitimeframe_agent', {
          method: 'POST',
          body: formData
        })
        .then(resp => resp.json())
        .then(data => {
          runMultiBtn.disabled = false;
          runMultiBtn.innerHTML = multiBtnOriginal;
          let html = '';
          if (Array.isArray(data.bias_summary) && data.bias_summary.length > 0) {
            html += '<h4>🧠 Multi-Timeframe Bias Summary</h4><ul>';
            data.bias_summary.forEach(item => {
              const conf = item.confidence !== undefined ? ` (${(item.confidence * 100).toFixed(0)}%)` : '';
              html += `<li><b>${item.interval || ''}</b>: ${item.bias_direction}${conf} — ${item.reasoning || ''}</li>`;
            });
            html += '</ul>';
          } else {
            html += '<div class="alert alert-info">No usable bias extracted. Try with a different image.</div>';
          }
          // --- Token usage/cost summary ---
          if (data.bias_cost_metadata) {
            const meta = data.bias_cost_metadata;
            const n = (meta.per_image_breakdown && meta.per_image_breakdown.length) ? meta.per_image_breakdown.length : 1;
            html += `<div class="small text-muted">Token usage: ${meta.total_tokens?.toLocaleString() || 0} tokens (x${n}), Cost: $${meta.total_cost_usd?.toFixed(4) || '0.0000'}`;
            if (meta.per_image_breakdown && meta.per_image_breakdown.length > 1) {
              html += `<details class="mt-1"><summary>Per-image breakdown</summary><ul style='margin-bottom:0;'>`;
              meta.per_image_breakdown.forEach((img, idx) => {
                html += `<li>Image ${idx + 1} (${img.interval || 'N/A'}): ${img.token_usage.totalTokenCount || 0} tokens, $${img.token_usage.cost_usd !== undefined ? Number(img.token_usage.cost_usd).toFixed(4) : 'N/A'}</li>`;
              });
              html += '</ul></details>';
            }
            html += '</div>';
          } else if (data.llm_token_usage) {
            html += `<div class="small text-muted">Token usage: ${data.llm_token_usage}, Cost: $${data.llm_cost_usd}</div>`;
          }
          // Always show raw Gemini JSON
          if (Array.isArray(data.raw_bias_data) && data.raw_bias_data.length > 0) {
            html += '<details class="mt-2" open><summary>Raw Gemini Vision Output</summary>';
            data.raw_bias_data.forEach(item => {
              html += `<pre>${JSON.stringify(item, null, 2)}</pre>`;
            });
            html += '</details>';
          }
          // Show feedback or LLM output if present
          if (data.feedback) {
            html += `<div class="alert alert-warning mt-2">${data.feedback}</div>`;
          }
          if (data.raw && typeof data.raw === 'string') {
            html += `<div class="alert alert-secondary mt-2"><strong>LLM Output:</strong><pre>${data.raw}</pre></div>`;
          }
          multiResultDiv.innerHTML = html;
          updateRegressionButtonState();
        })
        .catch(err => {
          runMultiBtn.disabled = false;
          runMultiBtn.innerHTML = multiBtnOriginal;
          multiResultDiv.innerHTML = `<div class='alert alert-danger'>Error: ${err}</div>`;
          updateRegressionButtonState();
        });
      });
    }

    // Instinct Agent chat
    document.getElementById('send_instinct_query').addEventListener('click', function() {
        const input = document.getElementById('instinct_query_input');
        const question = input.value.trim();
        if (!question) return;
        fetch('/query_instinct', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        })
        .then(response => response.json())
        .then(data => {
            const output = document.getElementById('instinct_output');
            const chat = document.createElement('div');
            chat.className = 'mt-2';
            chat.innerHTML = '<div class="alert alert-secondary"><strong>You:</strong> ' + question + '</div>' +
                '<div class="alert alert-info"><strong>Instinct Agent:</strong> <pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
            output.appendChild(chat);
            input.value = '';
        });
    });

    // Playbook Agent chat
    document.getElementById('send_playbook_query').addEventListener('click', function() {
        const input = document.getElementById('playbook_query_input');
        const question = input.value.trim();
        if (!question) return;
        fetch('/query_playbook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        })
        .then(response => response.json())
        .then(data => {
            const output = document.getElementById('playbook_output');
            const chat = document.createElement('div');
            chat.className = 'mt-2';
            chat.innerHTML = '<div class="alert alert-secondary"><strong>You:</strong> ' + question + '</div>' +
                '<div class="alert alert-success"><strong>Playbook Agent:</strong> <pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
            output.appendChild(chat);
            input.value = '';
        });
    });

    document.getElementById('enhance-instinct-btn').addEventListener('click', function() {
        showLoadingState('instinct');
        setButtonLoading(document.getElementById('enhance-instinct-btn'), true);
        fetchEnhance('instinct');
    });

    document.getElementById('enhance-playbook-btn').addEventListener('click', function() {
        showLoadingState('playbook');
        setButtonLoading(document.getElementById('enhance-playbook-btn'), true);
        fetchEnhance('playbook');
    });

    function fetchEnhance(agent) {
        const csvInput = document.getElementById(`enhance-${agent}-csv`);
        const notesInput = document.getElementById(`enhance-${agent}-notes`);
        const btn = document.getElementById(`enhance-${agent}-btn`);
        const output = document.getElementById(`${agent}_output`);
        const formData = new FormData();
        if (agent === 'instinct' && lastInstinctContext) {
            formData.append('previous_result', JSON.stringify(lastInstinctContext.result));
        }
        if (agent === 'playbook' && lastPlaybookContext) {
            formData.append('previous_result', JSON.stringify(lastPlaybookContext.result));
        }
        if (csvInput.files.length > 0) {
            formData.append('csv_file', csvInput.files[0]);
        }
        if (notesInput.value.trim()) {
            formData.append('enhance_notes', notesInput.value.trim());
        }
        fetch(`/enhance_${agent}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingState(agent);
            setButtonLoading(btn, false);
            if (agent === 'instinct') {
                output.innerHTML = '<div class="border border-info rounded p-2 mb-2 bg-light"><span class="badge bg-info text-dark">Enhanced Strategy Result</span></div>' + renderInstinctAgentResult(data);
            } else {
                output.innerHTML = '<div class="border border-info rounded p-2 mb-2 bg-light"><span class="badge bg-info text-dark">Enhanced Strategy Result</span></div>' + renderPlaybookAgentResult(data);
            }
            addTokens(extractTokenCount(data));
            if (data && data.rag_insights) {
                document.getElementById(`rag-${agent}-content`).innerHTML = renderRagMarkdown(data.rag_insights);
                document.getElementById(`rag-${agent}-panel`).style.display = 'block';
                flashRagPanel(agent);
            }
        });
    }

    function attachRegressionPredictorHandler() {
      const regBtn = document.getElementById('run-regression-strategy-btn');
      const regResultDiv = document.getElementById('regression-strategy-result');
      if (!regBtn || regBtn._handlerAttached) return;
      regBtn._handlerAttached = true;
      // --- Polling logic disabled: regression is synchronous for now ---
      // let polling = false;
      // let regressionInterval = null;
      let originalBtnHTML = regBtn.innerHTML;
      // let cancelRequested = false;
      // async function pollProgress() {
      //   regressionInterval = setInterval(async () => {
      //     try {
      //       const response = await fetch("/regression_backtest_progress");
      //       const data = await response.json();
      //       const { current, total, start_time, status } = data;
      //       if (total > 0) {
      //         const pct = Math.round((current / total) * 100);
      //         const elapsed = (Date.now() / 1000) - start_time;
      //         const estTotal = current > 0 ? (elapsed / current) * total : 0;
      //         const eta = current > 0 ? estTotal - elapsed : 0;
      //         regBtn.innerHTML = `<span class='spinner-border spinner-border-sm me-2' role='status' aria-hidden='true'></span>${pct}% (${eta > 0 ? eta.toFixed(0) : '...'}s left)`;
      //       } else {
      //         regBtn.innerHTML = `<span class='spinner-border spinner-border-sm me-2' role='status' aria-hidden='true'></span>Running...`;
      //       }
      //       if (status === "done" || status === "cancelled") {
      //         clearInterval(regressionInterval);
      //         regBtn.disabled = false;
      //         regBtn.innerHTML = originalBtnHTML;
      //         polling = false;
      //       }
      //       if (status === "cancelled") {
      //         regBtn.innerHTML = 'Cancelled';
      //       }
      //     } catch (e) {
      //       // Optionally handle error
      //     }
      //   }, 1000);
      // }
      // Add cancel button logic (optional, if you want to support cancel)
      // You can add a right-aligned cancel button next to the main button if desired
      regBtn.onclick = function() {
        if (regBtn.disabled) return;
        regBtn.disabled = true;
        regBtn.innerHTML = `<span class='spinner-border spinner-border-sm me-2' role='status' aria-hidden='true'></span>Running...`;
        regResultDiv.innerHTML = '';
        const csvFileInput = document.getElementById('csv_file');
        const files = csvFileInput && csvFileInput.files ? csvFileInput.files : [];
        const formData = new FormData();
        Array.from(files).forEach(file => formData.append('csv_files', file));
        console.log('Calling /run_regression_predictor with files:', Array.from(files).map(f => f.name));
        // polling = true;
        // pollProgress(); // --- DISABLED: synchronous, no progress bar ---
        fetch('/run_regression_predictor', {
          method: 'POST',
          body: formData
        })
        .then(resp => resp.json())
        .then(result => {
          regBtn.disabled = false;
          regBtn.innerHTML = originalBtnHTML;
          // polling = false;
          // clearInterval(regressionInterval);
          let out = '';
          if (result.feedback) {
            out += `<div class='alert alert-warning'>${result.feedback}</div>`;
          }
          if (result.strategy_name) {
            out += `<div class='card border-success mb-2'><div class='card-header bg-success text-white'><b>${result.strategy_name}</b></div><div class='card-body'>`;
            out += `<div class='mb-2'><b>Entry Conditions:</b> min_high_delta=${result.entry_conditions?.min_high_delta}, min_low_delta=${result.entry_conditions?.min_low_delta}</div>`;
            out += `<ul class='mb-2'>`;
            const s = result.backtest_summary || {};
            out += `<li><b>Num trades:</b> ${s.num_trades ?? '-'}</li>`;
            out += `<li><b>Win rate:</b> ${(s.win_rate*100).toFixed(1) ?? '-'}%</li>`;
            out += `<li><b>Avg return:</b> ${s.avg_return?.toFixed(2) ?? '-'}</li>`;
            out += `<li><b>Avg duration:</b> ${s.avg_duration?.toFixed(1) ?? '-'}</li>`;
            out += `<li><b>Max drawdown:</b> ${s.max_drawdown?.toFixed(2) ?? '-'}</li>`;
            out += `<li><b>Profit factor:</b> ${s.profit_factor?.toFixed(2) ?? '-'}</li>`;
            out += `</ul>`;
            if (result.llm_summary) {
              out += `<div class='mb-2'><b>Summary:</b> ${result.llm_summary}</div>`;
            }
            if (result.model_scores) {
              out += `<div class='mb-2'><b>Model R²:</b> high=${result.model_scores.high_r2?.toFixed(3)}, low=${result.model_scores.low_r2?.toFixed(3)}</div>`;
            }
            if (result.cost_metadata) {
              out += `<div class='small text-muted'>Tokens: ${result.cost_metadata.prompt_tokens || '-'} + ${result.cost_metadata.output_tokens || '-'}, Cost: $${result.cost_metadata.total_cost_usd?.toFixed(4) || '0.0000'}</div>`;
            }
            if (Array.isArray(result.top_strategies) && result.top_strategies.length > 0) {
              out += `<div class='card border-info mb-2'><div class='card-header bg-info text-white'><b>Top 3 Strategy Configurations</b></div><div class='card-body p-2'>`;
              out += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
              out += `<th>Long Threshold</th><th>Short Threshold</th><th>Win Rate</th><th>Avg Return</th><th>Profit Factor</th><th>Drawdown</th><th>Trades</th>`;
              out += `</tr></thead><tbody>`;
              result.top_strategies.forEach((cfg) => {
                out += `<tr>`;
                out += `<td>${cfg.long_threshold}</td>`;
                out += `<td>${cfg.short_threshold}</td>`;
                out += `<td>${(cfg.win_rate*100).toFixed(1)}%</td>`;
                out += `<td>${cfg.avg_return?.toFixed(2) ?? '-'}</td>`;
                out += `<td>${cfg.profit_factor?.toFixed(2) ?? '-'}</td>`;
                out += `<td>${cfg.max_drawdown?.toFixed(2) ?? '-'}</td>`;
                out += `<td>${cfg.num_trades ?? '-'}</td>`;
                out += `</tr>`;
              });
              out += `</tbody></table></div>`;
              out += `</div></div>`;
            }
            if (result.recommended_strategy_summary) {
              out += `<div class='alert alert-success mt-2 mb-2'><b>Recommended Strategy:</b> ${result.recommended_strategy_summary}</div>`;
            }
            out += `</div></div>`;
          }
          regResultDiv.innerHTML = out;
          // Show heatmap inline after regression results
          const heatmapHtml = `<div class="mt-3"><h5>Heatmap</h5><img src="/heatmap?t=${Date.now()}" alt="Heatmap" style="max-width:100%;border:1px solid #ccc;border-radius:8px;" /></div>`;
          regResultDiv.innerHTML += heatmapHtml;
          if (result.regression_trades_plot_path) {
            // Automatically open the plot in a new tab
            window.open(result.regression_trades_plot_path, '_blank');
            // Optionally, you can still show a message below the heatmap
            regResultDiv.innerHTML += `<div class="mt-3"><h5>Trades & Predictions Visualization opened in a new tab.</h5></div>`;
          }
          // After rendering the heatmap and metrics, add:
          if (result.llm_top_strategies) {
            console.log('[LLM DEBUG] llm_top_strategies:', result.llm_top_strategies, 'type:', typeof result.llm_top_strategies);
            let llmObj = result.llm_top_strategies;
            // If it's an array, render as table
            if (Array.isArray(llmObj)) {
                let llmInsightsDiv = document.getElementById('llm-strategy-insights-block');
                if (!llmInsightsDiv) {
                    llmInsightsDiv = document.createElement('div');
                    llmInsightsDiv.id = 'llm-strategy-insights-block';
                    regResultDiv.appendChild(llmInsightsDiv);
                }
                let html = `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
                html += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                html += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
                html += `</tr></thead><tbody>`;
                llmObj.forEach((s) => {
                    html += `<tr>`;
                    html += `<td>${s.name ?? '-'}</td>`;
                    html += `<td>${s.logic ?? '-'}</td>`;
                    html += `<td>${s.direction ?? '-'}</td>`;
                    html += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                    html += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                    html += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                    html += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                    html += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                    html += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                    html += `<td>${s.rationale ?? '-'}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody></table></div>`;
                llmInsightsDiv.innerHTML = html;
                // Add cost and model info below the table
                let costFields = [];
                const costVal = (result.llm_top_strategies?.llm_cost_usd !== undefined)
                    ? `$${parseFloat(result.llm_top_strategies.llm_cost_usd).toFixed(4)}`
                    : (result.llm_cost_usd !== undefined ? `$${parseFloat(result.llm_cost_usd).toFixed(4)}` : '-');
                costFields.push(`LLM Cost: ${costVal}`);
                const modelVal = result.llm_top_strategies?.model_name || result.llm_model_name || result.model_name || '-';
                costFields.push(`Model: ${modelVal}`);
                if (costFields.length > 0) {
                    llmInsightsDiv.innerHTML += `<div class='small text-muted mt-2'>${costFields.join(' | ')}</div>`;
                }
                return;
            }
            // ...existing object-based rendering...
            if (llmObj && typeof llmObj === 'object' && Array.isArray(llmObj.top_strategies)) {
              console.log('[LLM DEBUG] Rendering LLM table, top_strategies length:', llmObj.top_strategies.length);
              pretty = `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
              pretty += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
              pretty += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
              pretty += `</tr></thead><tbody>`;
              llmObj.top_strategies.forEach((s) => {
                pretty += `<tr>`;
                pretty += `<td>${s.name ?? '-'}</td>`;
                pretty += `<td>${s.logic ?? '-'}</td>`;
                pretty += `<td>${s.direction ?? '-'}</td>`;
                pretty += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                pretty += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                pretty += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                pretty += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                pretty += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                pretty += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                pretty += `<td>${s.rationale ?? '-'}</td>`;
                pretty += `</tr>`;
              });
              pretty += `</tbody></table></div>`;
              if (llmObj.explanation || llmObj.rationale) {
                pretty += `<div class='alert alert-info mt-2'><b>LLM Explanation:</b> ${llmObj.explanation ?? llmObj.rationale}</div>`;
              }
            } else {
              console.log('[LLM DEBUG] Fallback rendering for llm_top_strategies:', llmObj);
              // fallback: pretty print
              if (typeof result.llm_top_strategies === 'object') {
                pretty = `<pre>${JSON.stringify(result.llm_top_strategies, null, 2)}</pre>`;
              } else {
                pretty = `<pre>${result.llm_top_strategies}</pre>`;
              }
            }
            llmInsightsDiv = document.getElementById('llm-strategy-insights-block');
            if (!llmInsightsDiv) {
                llmInsightsDiv = document.createElement('div');
                llmInsightsDiv.id = 'llm-strategy-insights-block';
                regResultDiv.appendChild(llmInsightsDiv);
            }
            let llmInsightsHtml = `<div class='card mt-3'>
                <div class='card-header bg-primary text-white' style='cursor:pointer;' onclick='this.nextElementSibling.style.display = (this.nextElementSibling.style.display === "none" ? "block" : "none")'>
                    <b>📊 LLM Strategy Insights (Click to Expand/Collapse)</b>
                </div>
                <div class='card-body' style='display:block;'>`;
            // llm_summary
            if (result.llm_summary) {
                llmInsightsHtml += `<div class='mb-2'><b>LLM Summary:</b><br>${result.llm_summary}</div>`;
            }
            // recommended_strategy_summary
            if (result.recommended_strategy_summary) {
                llmInsightsHtml += `<div class='mb-2'><b>Recommended Strategy:</b><br>${result.recommended_strategy_summary}</div>`;
            }
            // llm_top_strategies
            if (result.llm_top_strategies) {
                let llmObj = result.llm_top_strategies;
                // If it's a string, try to parse as JSON (strip markdown fences)
                if (typeof llmObj === 'string') {
                    // Remove ```json ... ``` or ``` ... ```
                    let cleaned = llmObj.trim()
                        .replace(/^```json\s*/i, '')
                        .replace(/^```/, '')
                        .replace(/```$/, '')
                        .trim();
                    try {
                        llmObj = JSON.parse(cleaned);
                    } catch (e) {
                        llmInsightsHtml += `<div class='alert alert-warning'>Could not parse llm_top_strategies JSON: ${e}</div>`;
                        llmObj = null;
                    }
                }
                if (llmObj && typeof llmObj === 'object' && Array.isArray(llmObj.top_strategies)) {
                    llmInsightsHtml += `<div class='mb-2'><b>Top Strategies (LLM Selected):</b></div>`;
                    llmInsightsHtml += `<div class='table-responsive'><table class='table table-sm table-bordered mb-2'><thead class='table-light'><tr>`;
                    llmInsightsHtml += `<th>Name</th><th>Logic</th><th>Direction</th><th>Stop Loss (ticks)</th><th>Take Profit (ticks)</th><th>Profit Factor</th><th>Win Rate</th><th>Avg Daily PnL</th><th>Max Drawdown</th><th>Rationale</th>`;
                    llmInsightsHtml += `</tr></thead><tbody>`;
                    llmObj.top_strategies.forEach((s) => {
                        llmInsightsHtml += `<tr>`;
                        llmInsightsHtml += `<td>${s.name ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.logic ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.direction ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.stop_loss_ticks ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.take_profit_ticks ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.key_metrics?.profit_factor ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.key_metrics?.win_rate ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.key_metrics?.avg_daily_pnl ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.key_metrics?.max_drawdown ?? '-'}</td>`;
                        llmInsightsHtml += `<td>${s.rationale ?? '-'}</td>`;
                        llmInsightsHtml += `</tr>`;
                    });
                    llmInsightsHtml += `</tbody></table></div>`;
                    if (llmObj.explanation || llmObj.rationale) {
                        llmInsightsHtml += `<div class='alert alert-info mt-2'><b>LLM Explanation:</b> ${llmObj.explanation ?? llmObj.rationale}</div>`;
                    }
                } else if (llmObj) {
                    llmInsightsHtml += `<pre>${JSON.stringify(llmObj, null, 2)}</pre>`;
                }
            }
            // Cost fields
            let costFields = [];
            const costVal = (result.llm_top_strategies?.llm_cost_usd !== undefined)
                ? `$${parseFloat(result.llm_top_strategies.llm_cost_usd).toFixed(4)}`
                : (result.llm_cost_usd !== undefined ? `$${parseFloat(result.llm_cost_usd).toFixed(4)}` : '-');
            costFields.push(`LLM Cost: ${costVal}`);
            // Try to get model name from llm_top_strategies first, then top-level
            const modelVal = result.llm_top_strategies?.model_name || result.llm_model_name || result.model_name || '-';
            costFields.push(`Model: ${modelVal}`);
            if (costFields.length > 0) {
                llmInsightsHtml += `<div class='small text-muted mt-2'>${costFields.join(' | ')}</div>`;
            }
            llmInsightsHtml += `</div></div>`;
            llmInsightsDiv.innerHTML = llmInsightsHtml;
          }
        })
        .catch(err => {
          regBtn.disabled = false;
          regBtn.innerHTML = originalBtnHTML;
          regResultDiv.innerHTML = `<div class='alert alert-danger'>Error: ${err}</div>`;
        });
      };
    }

    // Attach handlers for regression predictor button
    attachRegressionPredictorHandler();

});
</script>