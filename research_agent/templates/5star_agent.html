<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>üåü Five Star Agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .dropzone {
      border: 2px dashed #6c757d; border-radius: 8px; background:#fff;
      padding: 28px; text-align:center; cursor:pointer;
    }
    .chat-area { max-height: 55vh; overflow-y: auto; background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .msg-user { background:#e7f1ff; border-radius:8px; padding:10px 12px; margin:6px 0; }
    .msg-agent { background:#f1f3f5; border-radius:8px; padding:10px 12px; margin:6px 0; }
    .file-pill { display:inline-flex; align-items:center; gap:8px; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:999px; padding:4px 10px; margin:3px; font-size:0.92rem; }
    .thumb { width:36px; height:24px; object-fit:cover; border-radius:4px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="d-flex align-items-center mb-3">
      <a href="/" class="btn btn-outline-secondary me-2">‚Üê Back</a>
      <h2 class="mb-0 me-3">üåü Five Star Agent</h2>
      <form method="POST" action="/five_star/reset" class="ms-auto">
        <button type="submit" class="btn btn-danger">Reset Session</button>
      </form>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-5">
        <div class="card">
          <div class="card-header fw-semibold">üñºÔ∏è Upload Weekly Charts</div>
          <div class="card-body">
            <form id="fivestar-form" action="/five-star-agent" method="POST" enctype="multipart/form-data">
              <div id="image-drop" class="dropzone mb-3" tabindex="0">
                <div class="mb-2">Drag & drop, click to select, or paste a screenshot (Ctrl+V)</div>
                <div class="text-muted">PNG/JPG/JPEG ‚Ä¢ Multi-select allowed</div>
                <input id="images-input" type="file" name="images" accept="image/png, image/jpeg" multiple class="d-none" />
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">ü§ñ Model</label>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-4o" value="gpt-4o" checked>
                    <label class="form-check-label" for="m-4o">gpt-4o</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-4o-mini" value="gpt-4o-mini">
                    <label class="form-check-label" for="m-4o-mini">gpt-4o-mini</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-4.1" value="gpt-4.1">
                    <label class="form-check-label" for="m-4.1">gpt-4.1</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-3.5" value="gpt-3.5-turbo">
                    <label class="form-check-label" for="m-3.5">gpt-3.5-turbo</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-g-pro" value="gemini-1.5-pro-latest">
                    <label class="form-check-label" for="m-g-pro">gemini-1.5-pro-latest</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-g-flash" value="gemini-1.5-flash-latest">
                    <label class="form-check-label" for="m-g-flash">gemini-1.5-flash-latest</label>
                  </div>
                </div>
              </div>
              <div id="file-list" class="mb-3"></div>
              <div class="mb-3">
                <label for="instructions" class="form-label fw-semibold">üí¨ Instructions (HE/EN)</label>
                <textarea id="instructions" name="instructions" rows="4" class="form-control" placeholder="e.g., ◊ë◊ì◊ï◊ß ◊ê◊ù ◊ô◊© ◊ò◊®◊†◊ì ◊¢◊ï◊ú◊î ◊ë◊®◊ï◊®... / Check for strong uptrend..."></textarea>
              </div>
              <div class="d-flex gap-2">
                <button id="send-btn" type="submit" class="btn btn-primary">Send to Agent</button>
                <button type="button" class="btn btn-outline-secondary" disabled title="Coming soon">Summarize</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-header fw-semibold">üìú Conversation</div>
          <div class="card-body">
            <div class="chat-area" id="chat-area">
              {% set show_history = request.args.get('show') == '1' %}
              {% if show_history and chat_history and chat_history|length > 0 %}
                {% for m in chat_history %}
                  <div class="{{ 'msg-user' if m.role == 'user' else 'msg-agent' }}">
                    <div class="small text-muted mb-1">{{ m.role|capitalize }} ‚Ä¢ {{ m.timestamp }}</div>
                    <div>{{ m.content }}</div>
                    {% if m.images and m.images|length > 0 %}
                      <div class="mt-1">
                        {% for fname in m.images %}
                          <span class="file-pill">üñºÔ∏è {{ fname }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted">No messages yet. Upload weekly charts and add instructions to begin.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // In-memory file store (supports drag/drop + paste + picker)
    const selectedFiles = [];

    function pushFiles(files) {
      if (!files || !files.length) return;
      for (const f of files) {
        if (!f) continue;
        // Avoid duplicates by name+size
        const dup = selectedFiles.find(x => x.name === f.name && x.size === f.size);
        if (!dup) selectedFiles.push(f);
      }
      renderFilePills();
    }

    function renderFilePills(){
      const fileListDiv = $('#file-list');
      fileListDiv.empty();
      if (selectedFiles.length === 0) return;
      selectedFiles.forEach(async f => {
        const pill = $('<span>').addClass('file-pill');
        const name = $('<span>').text(f.name + ' (' + Math.round(f.size/1024) + ' KB)');
        // Build thumbnail
        try {
          const url = URL.createObjectURL(f);
          const img = $('<img>').addClass('thumb').attr('src', url);
          pill.append(img);
        } catch {}
        pill.prepend($('<span>').text('üñºÔ∏è'));
        pill.append(name);
        fileListDiv.append(pill);
      });
    }

    // Click to open file picker
    $('#image-drop').on('click', function(){ $('#images-input').click(); });

    // Drag and drop
    $('#image-drop').on('dragover', function(e){ e.preventDefault(); $(this).addClass('border-primary'); });
    $('#image-drop').on('dragleave', function(e){ e.preventDefault(); $(this).removeClass('border-primary'); });
    $('#image-drop').on('drop', function(e){
      e.preventDefault(); $(this).removeClass('border-primary');
      const dt = e.originalEvent.dataTransfer; if (!dt || !dt.files?.length) return;
      pushFiles(dt.files);
    });

    // File input change
    $('#images-input').on('change', function(){ pushFiles(this.files); });

    // Paste screenshot support (Ctrl+V)
    $(document).on('paste', function(e){
      const clip = e.originalEvent.clipboardData; if (!clip) return;
      const items = clip.items || [];
      const files = [];
      for (const it of items) {
        if (it && it.type && it.type.indexOf('image') !== -1) {
          const blob = it.getAsFile();
          if (blob) {
            // Name the file with timestamp
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            const file = new File([blob], `pasted-${ts}.png`, { type: blob.type || 'image/png' });
            files.push(file);
          }
        }
      }
      if (files.length) {
        pushFiles(files);
      }
    });

    // Handle form submit: include all gathered files via fetch
    $('#fivestar-form').on('submit', async function(e){
      e.preventDefault();
      const btn = $('#send-btn');
      btn.prop('disabled', true).text('Sending...');
      try {
        const fd = new FormData();
        fd.append('instructions', $('#instructions').val() || '');
        // model choice
        const model = $('input[name="model_choice"]:checked').val();
        if (model) fd.append('model_choice', model);
        for (const f of selectedFiles) {
          fd.append('images', f, f.name);
        }
        const res = await fetch('/five_star/analyze', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Request failed');
        // If response contains usage, optionally show a toast before reload
        try {
          const data = await res.json();
          if (data && data.usage) {
            console.log('Model used:', data.usage.model_used, 'Tokens:', data.usage.total_tokens, 'Est. Cost:', data.usage.estimated_cost_usd);
          }
        } catch {}
        // Reload to render updated chat history (explicitly enable rendering)
        window.location.href = '/five-star-agent?show=1';
      } catch (err) {
        console.error(err);
        alert('Failed to send. Please try again.');
        btn.prop('disabled', false).text('Send to Agent');
      }
    });

    // Keep chat scrolled to bottom
    const chat = document.getElementById('chat-area');
    if (chat) { chat.scrollTop = chat.scrollHeight; }
  </script>
</body>
</html>

