<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ğŸŒŸ Five Star Agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .dropzone {
      border: 2px dashed #6c757d; border-radius: 8px; background:#fff;
      padding: 28px; text-align:center; cursor:pointer;
    }
    .chat-area { max-height: 55vh; overflow-y: auto; background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .msg-user { background:#e7f1ff; border-radius:8px; padding:10px 12px; margin:6px 0; }
    .msg-agent { background:#f1f3f5; border-radius:8px; padding:10px 12px; margin:6px 0; }
    .file-pill { display:inline-flex; align-items:center; gap:8px; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:999px; padding:4px 10px; margin:3px; font-size:0.92rem; }
    .thumb { width:36px; height:24px; object-fit:cover; border-radius:4px; border:1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container py-3">
    {% if request.args.get('reset') == '1' %}
    <div class="alert alert-success" role="alert">
      âœ… Session cleared. Memory and uploaded files were deleted.
    </div>
    {% endif %}
    <div class="d-flex align-items-center mb-3">
      <a href="/" class="btn btn-outline-secondary me-2">â† Back</a>
      <h2 class="mb-0 me-3">ğŸŒŸ Five Star Agent</h2>
      <form method="POST" action="/five_star/reset" class="ms-auto">
        <button type="submit" class="btn btn-danger">Reset Session</button>
      </form>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-5">
        <div class="card">
          <div class="card-header fw-semibold">ğŸ–¼ï¸ Upload Weekly Charts</div>
          <div class="card-body">
            <form id="fivestar-form" action="/five-star-agent" method="POST" enctype="multipart/form-data">
              <div id="image-drop" class="dropzone mb-3" tabindex="0">
                <div class="mb-2">Drag & drop, click to select, or paste a screenshot (Ctrl+V)</div>
                <div class="text-muted">PNG/JPG/JPEG â€¢ Multi-select allowed</div>
                <input id="images-input" type="file" name="images" accept="image/png, image/jpeg" multiple class="d-none" />
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">ğŸ¤– Model</label>
                {% set selected_model = request.args.get('model', 'gpt-4o') %}
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-5" value="gpt-5-2025-08" {% if selected_model.startswith('gpt-5') %}checked{% endif %}>
                    <label class="form-check-label" for="m-5">gpt-5-2025-08</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-4o" value="gpt-4o" {% if selected_model.startswith('gpt-4o') %}checked{% endif %}>
                    <label class="form-check-label" for="m-4o">gpt-4o</label>
                  </div>
                  {% if active_user != 'itz01' %}
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-g-pro" value="gemini-1.5-pro-latest" {% if selected_model.startswith('gemini-1.5-pro') %}checked{% endif %}>
                    <label class="form-check-label" for="m-g-pro">gemini-1.5-pro-latest</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="model_choice" id="m-g-flash" value="gemini-1.5-flash-latest" {% if selected_model.startswith('gemini-1.5-flash') %}checked{% endif %}>
                    <label class="form-check-label" for="m-g-flash">gemini-1.5-flash-latest</label>
                  </div>
                  {% endif %}
                </div>
                <!-- TODO: When OpenAI releases an image-capable GPT-5, add it here. -->
              </div>
              <div id="file-list" class="mb-3"></div>
              <div class="mb-3">
                <label for="instructions" class="form-label fw-semibold">ğŸ’¬ Instructions (HE/EN)</label>
                <textarea id="instructions" name="instructions" rows="4" class="form-control" placeholder="e.g., ×‘×“×•×§ ×× ×™×© ×˜×¨× ×“ ×¢×•×œ×” ×‘×¨×•×¨... / Check for strong uptrend..." autocomplete="off"></textarea>
              </div>
              <div class="d-flex gap-2">
                <button id="send-btn" type="submit" class="btn btn-primary">Send to Agent</button>
                <button type="button" class="btn btn-outline-secondary" disabled title="Coming soon">Summarize</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-header fw-semibold">ğŸ“œ Conversation</div>
          <div class="card-body">
            <div class="chat-area" id="chat-area">
              {% set show_history = request.args.get('show') == '1' %}
              {% if show_history and chat_history and chat_history|length > 0 %}
                {% for m in chat_history %}
                  <div class="{{ 'msg-user' if m.role == 'user' else 'msg-agent' }}">
                    <div class="small text-muted mb-1">{{ m.role|capitalize }} â€¢ {{ m.timestamp }}</div>
                    <div class="fivestar-content">{{ m.content }}</div>
                    {% if m.images and m.images|length > 0 %}
                      <div class="mt-1">
                        {% for fname in m.images %}
                          <span class="file-pill">ğŸ–¼ï¸ {{ fname }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted">No messages yet. Upload weekly charts and add instructions to begin.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function escapeHtml(s){
      return s
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    function addKeywordIcons(line){
      // light, non-destructive replacements for Hebrew keywords
      line = line.replace(/×¨××ª ×‘×™×˜×—×•×Ÿ:\s*×’×‘×•×”×”/g, 'ğŸŸ¢ ×¨××ª ×‘×™×˜×—×•×Ÿ: ×’×‘×•×”×”');
      // prefer whole-word-ish matches; keep original text
      line = line.replace(/(^|\s)××ª××™×(\W|$)/g, '$1âœ… ××ª××™×$2');
      line = line.replace(/(^|\s)×œ× ××ª××™×(\W|$)/g, '$1âŒ ×œ× ××ª××™×$2');
      return line;
    }

    function formatFiveStarResponse(raw){
      if (!raw || typeof raw !== 'string') return '';
      // If it doesn't contain the Five-Star response marker, return simple pre wrapped RTL
      const marker = 'ğŸ“ Model Response:';
      if (raw.indexOf(marker) === -1){
        return '<pre dir="rtl" style="text-align:right; white-space:pre-wrap; margin:0">' + escapeHtml(raw) + '</pre>';
      }

      const idx = raw.indexOf(marker);
      const preamble = raw.slice(0, idx).trim();
      let body = raw.slice(idx + marker.length).trim();

      const lines = body.split(/\r?\n/);
      // Group into numbered sections: lines starting with "<num>."
      const sections = [];
      let current = {title: '', items: []};
      for (let i=0;i<lines.length;i++){
        const ln = lines[i];
        const secMatch = ln.match(/^\s*(\d+)\.\s*(.*)$/);
        if (secMatch){
          if (current.title || current.items.length){ sections.push(current); }
          current = {title: secMatch[1] + '. ' + secMatch[2], items: []};
          continue;
        }
        // bullets start with -, â€“ or â€¢
        const bulletMatch = ln.match(/^\s*[\-â€“â€¢]\s*(.*)$/);
        if (bulletMatch){
          current.items.push(bulletMatch[1]);
        } else {
          // Non-bullet line; keep as-is (avoid dropping content)
          if (ln.trim().length){ current.items.push(ln); }
        }
      }
      if (current.title || current.items.length){ sections.push(current); }

      // Build HTML
      let html = '<div dir="rtl" style="text-align:right">';
      if (preamble){
        html += '<div class="text-muted" style="white-space:pre-wrap; margin-bottom:6px">' + escapeHtml(preamble) + '</div>';
      }
      html += '<div class="card" style="border:none">';
      html += '<div style="white-space:pre-wrap;">';

      if (sections.length === 0){
        // Fallback to raw body if we didn\'t detect sections
        html += '<pre dir="rtl" style="text-align:right; white-space:pre-wrap; margin:0">' + escapeHtml(body) + '</pre>';
      } else {
        for (const sec of sections){
          if (sec.title){
            html += '<div style="font-weight:600; margin-top:8px">' + escapeHtml(sec.title) + '</div>';
          }
          if (sec.items && sec.items.length){
            html += '<ul style="padding-inline-start:18px; margin:6px 0">';
            for (const it of sec.items){
              const t = addKeywordIcons(escapeHtml(it));
              html += '<li style="margin:2px 0">' + t + '</li>';
            }
            html += '</ul>';
          }
        }
      }
      html += '</div></div></div>';
      return html;
    }

    function applyFiveStarFormatting(){
      document.querySelectorAll('.msg-agent .fivestar-content').forEach(el => {
        try{
          const raw = el.textContent || '';
          el.innerHTML = formatFiveStarResponse(raw);
        } catch(e) { /* no-op */ }
      });
    }

    // Clear UI state on load
    window.addEventListener('load', () => {
      try {
        // Clear any retained file list / pills
        selectedFiles.length = 0;
        $('#file-list').empty();
        // Clear form fields
        $('#instructions').val('');
      } catch {}
      try { applyFiveStarFormatting(); } catch {}
    });
    // In-memory file store (supports drag/drop + paste + picker)
    const selectedFiles = [];

    function pushFiles(files) {
      if (!files || !files.length) return;
      for (const f of files) {
        if (!f) continue;
        // Avoid duplicates by name+size
        const dup = selectedFiles.find(x => x.name === f.name && x.size === f.size);
        if (!dup) selectedFiles.push(f);
      }
      renderFilePills();
    }

    function renderFilePills(){
      const fileListDiv = $('#file-list');
      fileListDiv.empty();
      if (selectedFiles.length === 0) return;
      selectedFiles.forEach(async f => {
        const pill = $('<span>').addClass('file-pill');
        const name = $('<span>').text(f.name + ' (' + Math.round(f.size/1024) + ' KB)');
        // Build thumbnail
        try {
          const url = URL.createObjectURL(f);
          const img = $('<img>').addClass('thumb').attr('src', url);
          pill.append(img);
        } catch {}
        pill.prepend($('<span>').text('ğŸ–¼ï¸'));
        pill.append(name);
        fileListDiv.append(pill);
      });
    }

    // Click to open file picker
    $('#image-drop').on('click', function(){ $('#images-input').click(); });

    // Drag and drop
    $('#image-drop').on('dragover', function(e){ e.preventDefault(); $(this).addClass('border-primary'); });
    $('#image-drop').on('dragleave', function(e){ e.preventDefault(); $(this).removeClass('border-primary'); });
    $('#image-drop').on('drop', function(e){
      e.preventDefault(); $(this).removeClass('border-primary');
      const dt = e.originalEvent.dataTransfer; if (!dt || !dt.files?.length) return;
      pushFiles(dt.files);
    });

    // File input change
    $('#images-input').on('change', function(){ pushFiles(this.files); });

    // Paste screenshot support (Ctrl+V)
    $(document).on('paste', function(e){
      const clip = e.originalEvent.clipboardData; if (!clip) return;
      const items = clip.items || [];
      const files = [];
      for (const it of items) {
        if (it && it.type && it.type.indexOf('image') !== -1) {
          const blob = it.getAsFile();
          if (blob) {
            // Name the file with timestamp
            const ts = new Date().toISOString().replace(/[:.]/g, '-');
            const file = new File([blob], `pasted-${ts}.png`, { type: blob.type || 'image/png' });
            files.push(file);
          }
        }
      }
      if (files.length) {
        pushFiles(files);
      }
    });

    // Handle form submit: include all gathered files via fetch
    $('#fivestar-form').on('submit', async function(e){
      e.preventDefault();
      const btn = $('#send-btn');
      btn.prop('disabled', true).text('Sending...');
      try {
        const fd = new FormData();
        fd.append('instructions', $('#instructions').val() || '');
        // model choice
        const model = $('input[name="model_choice"]:checked').val();
        if (model) fd.append('model_choice', model);
        for (const f of selectedFiles) {
          fd.append('images', f, f.name);
        }
        const res = await fetch('/five_star/analyze', { method: 'POST', body: fd });
        if (!res.ok) throw new Error('Request failed');
        // If response contains usage, optionally show a toast before reload
        try {
          const data = await res.json();
          if (data && data.usage) {
            console.log('Model used:', data.usage.model_used, 'Tokens:', data.usage.total_tokens, 'Est. Cost:', data.usage.estimated_cost_usd);
          }
        } catch {}
        // Reload to render updated chat history (explicitly enable rendering and keep model selection)
        const qModel = encodeURIComponent(model || 'gpt-4o');
        window.location.href = '/five-star-agent?show=1&model=' + qModel;
      } catch (err) {
        console.error(err);
        alert('Failed to send. Please try again.');
        btn.prop('disabled', false).text('Send to Agent');
      }
    });

    // Keep chat scrolled to bottom
    const chat = document.getElementById('chat-area');
    if (chat) { chat.scrollTop = chat.scrollHeight; }
  </script>
</body>
</html>

