<div class="mb-2 small-muted">Upload up to 10 TradeStation optimization reports (.csv)</div>
<form id="opt-form">
  <div id="opt-file-list" class="mb-2 small" style="min-height:3em; max-height:7em; border: 2px solid #007bff; background: #fffbe6; border-radius: 8px; padding: 12px 18px; margin-bottom: 14px; font-size: 1.15rem; color: #222; display: block; font-weight: 500; overflow:auto;"></div>
  <input class="form-control mb-2" type="file" id="opt-files" accept=".csv" multiple>
  <button class="btn btn-primary" type="submit">Analyze Optimizations</button>
  <div class="small text-muted mt-1">Output appears below. LLM cost and model will be shown if available.</div>
  <div id="opt-status" class="mt-2"></div>
  <div id="opt-output" class="mt-3"></div>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Lightweight formatter so optimization rationale shows emoji/headings
  window._vwapOptFormat = function(raw){
    try{
      if (!raw) return '';
      let text = String(raw).trim();
      text = text.replace(/^###\s*(.*risk.*|.*drawdown.*)$/gim, '### ‚ö†Ô∏è $1');
      text = text.replace(/^##\s*(.*risk.*|.*drawdown.*)$/gim, '## ‚ö†Ô∏è $1');
      text = text.replace(/^###\s*(.*profit.*|.*pnl.*)$/gim, '### üìà $1');
      text = text.replace(/^##\s*(.*profit.*|.*pnl.*)$/gim, '## üìà $1');
      text = text.replace(/^###\s*(.*reason.*|.*llm.*)$/gim, '### üß† $1');
      text = text.replace(/^##\s*(.*reason.*|.*llm.*)$/gim, '## üß† $1');
      if (window.marked && window.marked.parse) {
        return '<div class="llm-enhanced">' + window.marked.parse(text) + '</div>';
      }
      return '<div class="llm-enhanced">'
        + text.replace(/^###\s*(.*)$/gim, '<h4>$1</h4>')
              .replace(/^##\s*(.*)$/gim, '<h3>$1</h3>')
              .replace(/^#\s*(.*)$/gim, '<h2>$1</h2>')
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\n/g, '<br>')
        + '</div>';
    }catch(e){return String(raw)}
  }

  // --- Optimization file list and results logic ---
  const optFilesInput = document.getElementById('opt-files');
  const optFileList = document.getElementById('opt-file-list');
  const optForm = document.getElementById('opt-form');
  const optOutput = document.getElementById('opt-output');
  const optStatus = document.getElementById('opt-status');

  function updateOptFileList() {
    const files = optFilesInput.files;
    if (!files || files.length === 0) {
      optFileList.innerHTML = '<span class="text-muted">No files selected.</span>';
      optFileList.style.display = 'block';
      return;
    }
    let html = '<ul class="mb-0" style="padding-left: 1.2em;">';
    for (let i = 0; i < files.length; ++i) {
      html += `<li style='margin-bottom:2px;'>üìÑ <b>${files[i].name}</b></li>`;
    }
    html += '</ul>';
    optFileList.innerHTML = html;
    optFileList.style.display = 'block';
  }
  optFilesInput.addEventListener('change', updateOptFileList);
  optFilesInput.addEventListener('input', updateOptFileList); // for some browsers
  updateOptFileList(); // Initial

  optForm.addEventListener('submit', function(e) {
    // Clear output/results area immediately on run
    if (optOutput) optOutput.innerHTML = '';
    if (optStatus) optStatus.innerHTML = '';
    // Optionally, show a loading spinner or message here
  });
});
</script>
